<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Neeti's After School App</title>
        <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    </head>
    <body>
        <div id="app">
            <div style="display:inline-block;">
                <header>
                    <h1 v-text="sitename"></h1>
                </header>
            </div>
            
            <main>
                <div style="text-align: right">
                    <button v-on:click='showShoppingCart' :disabled='!enableShoppingCart()'>
                        {{cartItemCount}}
                        <i class="fa-solid fa-cart-shopping"></i>
                    
                        Shopping Cart
                    </button>
                </div>
                <div v-if='showLesson'>
                    <div v-for="lesson in sortedLessons">
                        <!-- the code for the lesson page -->
                        <div style="display:inline-block;">
                            <figure>
                                <!-- bind 'src' attr to 'lesson.image' in 'data' -->
                                <img v-bind:src="lesson.image">
                            </figure>
                        </div>
                        <div style="display:inline-block;">
                            <h2 v-text="lesson.subject"></h2>
                            <p v-html="lesson.location"></p>

                            <!-- The double curly brackets is used instead of 'v-text' -->
                            <p>Price: {{lesson.price}}</p>
                            <!-- This will hide the button when canAddToCart returns false. -->
                            <!-- <button v-on:click='addToCart(lesson)' v-if='canAddToCart(lesson)'> Add to cart</button> --> 
                        
                            <!-- This will disable the button when canAddToCart returns false. -->
                            <button v-on:click='addToCart(lesson)' :disabled='!canAddToCart(lesson)'> Add to cart</button> 
                            
                            <span v-if='lesson.availableSpaces === cartCount(lesson.id)'>No spaces!</span>
                            <span v-else-if="lesson.availableSpaces - cartCount(lesson.id) < 5">
                                Only {{lesson.availableSpaces - cartCount(lesson.id)}} spaces left!
                            </span>
                            <span v-else>Enrol now!</span>
                            <br>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <!-- the code for the checkout page -->
                    <h2>ShoppingCart</h2>
                    <p>
                        <strong>Name:</strong>
                        <!-- This input field is bound to 'name' in the 'order' object -->
                        <input v-model.trim="order.name" @input="order.name = order.name.replace(/[^A-Za-z ]/g,'')" placeholder="Letters only"/>
                    </p>
                    <p>
                        <strong>Phone:</strong>
                        <input v-model.trim="order.phone" @input="order.phone = order.phone.replace(/[^0-9]/g,'')" placeholder="Numbers only"/>
                    </p>
                    <h2>Order Information</h2>
                    <p>Name: {{order.name}}</p>
                    <p>Phone: {{order.phone}}</p>
                    <button v-on:click="submitForm" :disabled='!canCheckOut()'>Check Out</button>
                </div>
            </main>
        </div>
        <script type="text/javascript">
            var afterSchool = new Vue({
                el:'#app',//<===Don't forget this comma
                data() {    // returns default null string values for name and phone no., if not entered by user
                    return {
                        name: "",
                        phone: ""
                    }
                },
                data: { //the 'data' option
                    //the key 'sitename' matches the value of 'v-text' earlier
                    sitename: "Neeti's After School App",
                    showLesson: true,
                    order: {
                        name: '',
                        phone: ''
                    },
                    //We need to read lessons from the server/database
                    lessons: [], // array to read lessons from the server
                    cart: [] // array to store items in shopping cart
                },
                //  Fetch function to GET all the lessons from mongoDB database in lessons collection
                created: function () {
                    console.log('requesting data from server ...');
                            
                    fetch('https://cst3144-neeti-express.onrender.com/collection/lessons').then (
                        function (response) {
                            response.json().then (
                                function (json) {
                                    // save the returned JSON object to
                                    // 'product' data property
                                    afterSchool.lessons = json;
                                    console.log(json);
                                });
                        }
                    )
                },
                methods: {
                    addToCart(lesson) {
                        this.cart.push(lesson.id);
                    },
                    canAddToCart(lesson) {
                        return lesson.availableSpaces > this.cartCount(lesson.id);
                    },
                    cartCount(id) {
                        let count = 0;
                        for(let i = 0; i < this.cart.length; i++) {
                            if (this.cart[i] === id) {
                                count++;
                            }
                        }
                        return count;
                    },
                    enableShoppingCart() {
                        return this.cart.length > 0;
                    },
                    showShoppingCart() {
                        this.showLesson = this.showLesson ? false : true; 
                    },
                    canCheckOut() {
                        return this.order.name !== "" && this.order.phone !== ""; 
                    },
                    //  Fetch function to POST order details to mongoDB database in orders collection
                    async postOrderDetails() {
                        try {
                            const response = await fetch("https://cst3144-neeti-express.onrender.com/collection/orders", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    name: this.order.name,
                                    phone: this.order.phone,
                                    lessonIds: this.cart
                                })
                            });
                            const result = await response.json();
                            console.log("Server Response:", result);
                        } catch (error) {
                            console.error("POST Error:", error);
                        }
                    },
                    //  Fetch function to PUT available spaces to mongoDB database in lessons collection
                    async updateAvailableSpaces() {
                        console.log('lessons.length = ' + this.lessons.length);
                        for(let i = 0; i < this.lessons.length; i++) {

                            //If the cart contains lesson with this id, only then update the available spaces in the database
                            if (this.cartCount(this.lessons[i].id) > 0) {
                                try {
                                    console.log(`this.lessons[i]._id = ${this.lessons[i]._id}`);

                                    console.log('Available spaces left for this lesson = ' + String(this.lessons[i].availableSpaces - this.cartCount(this.lessons[i].id)));
                                    const response = await fetch(`https://cst3144-neeti-express.onrender.com/collection/lessons/${this.lessons[i]._id}`, {
                                        method: "PUT",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify({
                                            availableSpaces: this.lessons[i].availableSpaces - this.cartCount(this.lessons[i].id)
                                        })
                                    });
                                    const result = await response.json();
                                    console.log("PUT Response:", result);
                                } catch (error) {
                                    console.error("PUT Error:", error);
                                }
                            }
                        }
                    },
                    submitForm() {
                        console.log("Name = " + this.order.name + "Phone = " + this.order.phone);
                        console.log("Lessons ordered = " + this.cart);
                        alert('Order submitted!');
                        console.log('Sending order details to the server ...');
                        this.postOrderDetails(); // POST order details to the server
                        console.log('Sending available spaces update to the server ...');
                        this.updateAvailableSpaces(); // update available spaces in each lesson (using PUT) to the server
                    },
                },
                computed: { //the Computed Property object
                    cartItemCount: function() {//the property name
                        //its value is calculated when it's called
                        return this.cart.length || "";
                    },
                    itemsLeft() {
                        return this.lesson.availableSpaces - this.cartItemCount;
                    },
                    sortedLessons() {
                        //the comparison function that defines the order
                        function compare(a, b) {
                            if (a.price > b.price) return 1;
                            if (a.price < b.price) return -1;
                            return 0;
                        }
                        
                        // sort the 'lessons' array and return it
                        return this.lessons.sort(compare);
                    }
                }
            });
        </script>
    </body>
</html>